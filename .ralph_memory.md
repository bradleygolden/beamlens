# Ralph Memory

## Active Work
- PR #25: Busy Port Detection and Monitoring (open, all checks passing, awaiting review)
  - Branch: ralph/busy-port-detection
  - All 557 tests passing (5 new tests for busy port events)
  - Credo: 934 mods/funs, 0 issues
  - Dialyzer: 0 errors, 0 warnings
  - busy_port and busy_dist_port event handlers in EventStore
  - New stats: busy_port_count_5m, busy_dist_port_count_5m, affected_port_count
  - Ports skill callbacks: ports_busy_events, ports_busy_dist_events
  - SystemMonitor skill updated with busy port patterns
  - Zero production impact: read-only monitoring
  - Handles OTP versions without busy port support (rescue ArgumentError)
  - Dialyzer ignore directive for configure_busy_port_monitoring/3
  - Documentation follows LLM inference pattern (no prescriptive steps)
  - Rebased onto upstream main (2026-01-21) - PR #24 merge caused conflicts
  - One commit dropped (LLM inference patterns already in AGENTS.md from PR #24)
  - CHANGELOG.md merge conflict resolved (both atom and busy port entries included)
  - All 7 CI checks: SUCCESS (2026-01-21T20:15:37Z)
  - **2026-01-21 Research: Thorough review completed, NO improvements found**
  - Code quality matches PR #24 standards, production-ready
  - Test coverage excellent with proper edge case handling
  - OTP version compatibility pattern correctly implemented
  - No review comments or feedback awaiting response
  - Status: Ready for merge, awaiting upstream review

## Ready to Implement (Next Priority)
- Issue #5: Crash Dump Analysis Automation (queued, awaiting Issue #4 completion)
  - Parse erl_crash.dump files automatically
  - Extract memory, process, port metrics
  - Classify crash causes with evidence
  - Generate investigation recommendations
  - Zero production impact: offline analysis
  - Create new CrashDump skill

## Completed
- #42 - Binary Leak Detection (PR #15) - Merged upstream
- #2 - Message Queue Overload Detection (PR #19) - Merged upstream (2026-01-21)
- #3 - Binary Memory Leak Detection (PR #18) - Merged upstream (2026-01-21)
- Scheduler Utilization Tracking (PR #20) - Merged upstream (2026-01-21)
- System Monitor Events - PR #21 Merged upstream (2026-01-21)
  - All 7 CI checks passed
  - All 521 tests passing (44 system monitor tests)
  - Comprehensive GenServer testing (26 EventStore tests)
  - Performance impact: minimal (~100KB ring buffer)
- ETS Growth Tracking - PR #22 Merged upstream (2026-01-21)
  - GrowthStore GenServer for periodic table size sampling
  - Growth rate analysis and leak detection callbacks
  - Supervision tree integration
  - 24 tests passing (all ETS skill tests including 8 new GrowthStore tests)
  - All 7 CI checks passing
- Process Reduction Profiling - PR #23 Merged upstream (2026-01-21)
  - 4 new callbacks for reduction analysis
  - All 540 tests passing
  - All 7 CI checks passing
  - Comprehensive test coverage (13 new tests)
- Atom Table Growth Monitoring - PR #24 Merged upstream (2026-01-21)
  - AtomStore GenServer for periodic atom count sampling
  - Growth rate analysis and leak detection callbacks
  - Supervision tree integration
  - All 552 tests passing
  - All 7 CI checks passing
  - Callback design refined based on review: removed overly specific callbacks
  - Documentation refined to LLM inference pattern (conceptual, not prescriptive)

## Queue
- Issue #5: Crash dump analysis (next after PR #25 merge)
- After that: Production tracing integration (Phase 3, medium impact)
- Issue tracking: Can create/manage issues on bradleygolden/beamlens fork
- Current state: 2/2 open issues (at limit), 1/1 open PR to beamlens (PR #25 - at limit)
- Next action: Create next issue once PR #25 merges (to stay within state limits)

## Patterns
- Use :erlang.memory(:binary) for leak detection
- Process.info/2 for queue lengths
- :erlang.system_flag(:scheduler_wall_time, true) for scheduler utilization
- :erlang.system_monitor/2 for long_gc/long_schedule events
- Enum.max with empty list guard: `if list == [], do: 0, else: Enum.max(list)`
- All operations must be read-only
- Follow AGENTS.md conventions strictly
- Handle OTP version compatibility with rescue ArgumentError for unsupported features
- Always rebase feature branches onto upstream main before pushing
- Test GenServer state via public APIs, not internal state inspection
- Use GenServer with init/1 initial sample for immediate availability
- Use `send(pid, :message)` for synchronous test control of GenServers
- **Use pattern matching and guards to avoid deeply nested code** - Credo max depth is 2
- **Extract complex calculations into helper functions with guard clauses** for readability
- **Edge case testing**: Create tests that manipulate data to trigger edge conditions (e.g., identical timestamps)

## Learnings
- Test setup: Use `setup_all` with `start_supervised!` for singleton processes like Puck.Test
  - Puck.Test lacks child_spec/1, must provide: `%{id: Puck.Test, start: {Puck.Test, :start_link, []}}`
  - setup_all preferred over setup for singletons started once per test suite
- Review feedback: Address all review comments promptly
  - You're a capable LLM - you only need guidance, not detailed instructions
  - Reviewers' questions are hints, not mandates - use judgment
- **IMPORTANT**: Always double-check PR review comments regardless of memory
  - Memory may say "addressed" but comments may still show as unresolved on GitHub
  - Verify by checking: gh api repos/owner/repo/pulls/N/comments
  - Look for null state or lack of "RESOLVED" status
  - Cross-reference commit timestamps with comment timestamps to verify response
- Non-critical comments: Remove explanatory comments that don't add value
  - Code should be self-documenting through clear naming
- **LLM Inference Pattern (PR #24 feedback)**:
  - Avoid overly prescriptive documentation - LLMs can infer from guidance
  - Hard-coding deterministic steps is a code smell
  - Let LLMs synthesize insights rather than following step-by-step recipes
  - Document intent and patterns, not every field or implementation detail
  - Only use determinism where inference is 100% not needed
  - **Applied to PR #24**: Removed field enumeration from callback docs, removed hard-coded thresholds, kept conceptual guidance
- **Erlang :queue module API (PR #24 research finding)**:
  - `:queue.in/2` adds to the rear (back) of the queue
  - `:queue.out/1` removes from the front (oldest item)
  - `:queue.out_r/1` removes from the rear (newest item)
  - `:queue.to_list/1` returns list with oldest first
  - **Critical**: Use `:queue.out_r` to get the newest item, not `:queue.out`
  - **Pattern**: When storing time-series samples in a queue with `:queue.in`, the newest sample is at the rear
  - **Test requirement**: Always verify "get_latest" returns newest sample, not just any sample
- **Division by zero edge case** (PR #24 research finding):
  - Time-based calculations can fail when time delta is 0 (e.g., identical timestamps)
  - Use pattern matching with guards: `when time_window_minutes == 0.0`
  - Extract edge case handling into separate function clause for clarity
  - **Test pattern**: Manipulate sample data to trigger edge conditions without waiting for rare timing events
- **Test code duplication** (PR #24 research finding):
  - Duplicating production logic in test helpers is acceptable when testing edge cases
  - Edge cases like identical timestamps are hard to trigger in normal operation
  - Test helpers like `beam_growth_rate_with_samples` allow controlled edge case simulation
  - This follows the guidance: "Manipulate sample data to trigger edge conditions"
  - The duplication is intentional and serves a specific testing purpose
- **Callback design pattern** (PR #24 review feedback):
  - Avoid callbacks that only return static information (errors or patterns)
  - LLMs can synthesize limitations, error cases, and best practices from context
  - Only provide callbacks that add actionable value beyond what LLMs can infer
  - Examples removed:
    - beam_node_name_atoms: Only returned "cannot_enumerate_atoms" error (LLM can infer)
    - beam_check_atom_safety: Hardcoded static patterns (LLM can infer from context)
- **OTP version compatibility handling** (busy-port implementation):
  - Some system_monitor options (busy_port, busy_dist_port) not available in all OTP versions
  - Wrap unsupported calls in rescue ArgumentError to handle gracefully
  - Use @dialyzer {:nowarn_function, ...} to suppress dialyzer warnings for version-specific code
  - Pattern: rescue for OTP version differences, catch for other errors
  - This allows forward compatibility while supporting older OTP versions
- **Dialyzer and version-specific features**:
  - Dialyzer checks typespecs against Erlang/OTP built-in types
  - New OTP features may not exist in typespecs of older versions
  - Use @dialyzer {:nowarn_function, ...} directive when intentionally using newer features
  - Rescue clause provides runtime safety, dialyzer directive provides compile-time suppression
  - This pattern enables optional features that gracefully degrade on older OTP versions
- **PR #24 Research (2026-01-21)**: Thoroughly reviewed atom table growth implementation
  - Code quality: Credo reports 931 mods/funs, 0 issues (clean)
  - Type safety: Dialyzer passes with 0 errors
  - Test coverage: All 552 tests passing (removed 4 tests for deleted callback)
  - GenServer consistency: AtomStore matches GrowthStore pattern exactly (good)
  - Documentation: Refined to LLM inference pattern (conceptual, not prescriptive)
  - Callback design: Removed beam_node_name_atoms and beam_check_atom_safety (LLM can infer)
  - Edge cases: Tested identical timestamps, division by zero, queue operations
  - State management: Proper use of :queue module with correct out_r for newest sample
  - Bug fixes: Queue operations and division by zero edge cases handled
  - Supervision: Properly integrated into supervision tree
  - CHANGELOG: Removed dev-only bug fix entry (division by zero was introduced during development)
  - No improvements found - PR is solid and ready for merge
- **PR #25 Research (2026-01-21)**: Thoroughly reviewed busy port detection implementation
  - Code quality: Credo reports 934 mods/funs, 0 issues (clean)
  - Type safety: Dialyzer passes with 0 errors, 0 warnings
  - Test coverage: All 557 tests passing (5 new busy port tests)
  - EventStore consistency: Matches existing long_gc/long_schedule pattern exactly
  - OTP version compatibility: Proper rescue ArgumentError pattern for unsupported features
  - Documentation: Follows LLM inference pattern from PR #24 (conceptual guidance)
  - Edge cases: Tests gracefully handle Port.list() empty scenario
  - Handler pattern: Identical to existing event handlers (consistent codebase)
  - Statistics calculation: Includes all new fields (busy_port_count_5m, busy_dist_port_count_5m, affected_port_count)
  - Event formatting: Proper type-specific field handling (port field only for busy_port types)
  - Integration: Ports skill callbacks properly reference EventStore
  - SystemMonitor skill: Updated with busy port analysis patterns
  - CHANGELOG: Concise entry following existing format
  - No improvements found - PR is production-ready and equals PR #24 quality standards
  - 100% confidence in implementation quality
